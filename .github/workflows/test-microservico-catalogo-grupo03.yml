name: Testes MicroserviÃ§o Carrinho - Grupo 04

on:
  workflow_run:
    workflows: ["ğŸ—ï¸ Build do MicrosserviÃ§o"]
    types: [completed]

jobs:
  test:
    runs-on: ubuntu-latest
    steps:
      - name: ğŸ“¥ Baixar artifact do build
        uses: actions/download-artifact@v3
        with:
          name: app-build
          path: .

      - name: â–¶ï¸ Iniciar servidor
        run: |
          node app.js &
          sleep 5  # Tempo maior para garantir inicializaÃ§Ã£o
          echo "ğŸ”„ Servidor pronto em localhost:3000"

      - name: ğŸ§ª Teste de produto existente (ID 101)
        run: |
          RESPONSE=$(curl -s "http://localhost:3000/products/check?productId=101")
          if ! echo "$RESPONSE" | grep -q '"available":true'; then
            echo "âŒ Falha: produto 101 deveria estar disponÃ­vel"
            exit 1
          fi

      - name: ğŸ§ª Teste de produto inexistente (ID 999)
        run: |
          STATUS=$(curl -s -o /dev/null -w "%{http_code}" "http://localhost:3000/products/check?productId=999")
          if [ "$STATUS" -ne 404 ]; then
            echo "âŒ Falha: status 404 esperado, recebido $STATUS"
            exit 1
          fi

      - name: ğŸ“Š RelatÃ³rio de cobertura (Opcional)
        run: echo "âœ… Todos os testes passaram"
