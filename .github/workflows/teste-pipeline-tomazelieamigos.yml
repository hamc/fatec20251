name: ğŸš€ CI/CD Pipeline - MicroserviÃ§o Estoque.io

on:
  push:
    branches: [ main, develop ]
    paths:
      - 'servico-estoque/**'
  pull_request:
    branches: [ main ]
    paths:
      - 'servico-estoque/**'
  workflow_dispatch:  # Permite execuÃ§Ã£o manual

env:
  NODE_VERSION: '18'
  SERVICE_PORT: 3000
  WORKING_DIR: 'servico-estoque'

jobs:
  # Job de validaÃ§Ã£o inicial
  validate:
    name: ğŸ” ValidaÃ§Ã£o Inicial
    runs-on: ubuntu-latest
    outputs:
      should-deploy: ${{ steps.changes.outputs.should-deploy }}
    
    steps:
    - name: ğŸ“¥ Checkout do cÃ³digo
      uses: actions/checkout@v4
      with:
        fetch-depth: 2
        
    - name: ğŸ” Verificar mudanÃ§as relevantes
      id: changes
      run: |
        if git diff --name-only HEAD~1 HEAD | grep -E '^servico-estoque/(server\.js|package\.json|data/)'; then
          echo "should-deploy=true" >> $GITHUB_OUTPUT
          echo "âœ… MudanÃ§as crÃ­ticas detectadas - pipeline completo serÃ¡ executado"
        else
          echo "should-deploy=false" >> $GITHUB_OUTPUT
          echo "â„¹ï¸ Apenas mudanÃ§as menores detectadas"
        fi
        
    - name: ğŸ“‹ Listar arquivos modificados
      run: |
        echo "ğŸ“„ Arquivos modificados neste commit:"
        git diff --name-only HEAD~1 HEAD | grep '^servico-estoque/' || echo "Nenhum arquivo do serviÃ§o modificado"

  # Job de build otimizado
  build:
    name: ğŸ”¨ Build & AnÃ¡lise
    runs-on: ubuntu-latest
    needs: validate
    
    steps:
    - name: ğŸ“¥ Checkout do cÃ³digo
      uses: actions/checkout@v4
      
    - name: ğŸŸ¢ Configurar Node.js ${{ env.NODE_VERSION }}
      uses: actions/setup-node@v4
      with:
        node-version: ${{ env.NODE_VERSION }}
        cache: 'npm'
        cache-dependency-path: '${{ env.WORKING_DIR }}/package-lock.json'
        
    - name: ğŸš€ InÃ­cio do processo de build
      run: |
        echo "ğŸ”¨ Iniciando build do microserviÃ§o Estoque.io..."
        echo "ğŸ“Š InformaÃ§Ãµes do ambiente:"
        echo "  - Node.js: $(node --version)"
        echo "  - NPM: $(npm --version)"
        echo "  - Sistema: $(uname -a)"
      
    - name: ğŸ“¦ Instalar dependÃªncias
      run: |
        cd ${{ env.WORKING_DIR }}
        echo "ğŸ“¥ Instalando dependÃªncias..."
        npm ci --prefer-offline --no-audit
        echo "âœ… DependÃªncias instaladas com sucesso!"
        
    - name: ğŸ” AnÃ¡lise de seguranÃ§a
      run: |
        cd ${{ env.WORKING_DIR }}
        echo "ğŸ”’ Executando auditoria de seguranÃ§a..."
        npm audit --audit-level=moderate || echo "âš ï¸ Vulnerabilidades encontradas - revisar posteriormente"
        
    - name: ğŸ“Š AnÃ¡lise do projeto
      run: |
        cd ${{ env.WORKING_DIR }}
        echo "ğŸ“‹ Estrutura do projeto:"
        find . -type f -name "*.js" -o -name "*.json" | head -20
        echo ""
        echo "ğŸ“„ InformaÃ§Ãµes do package.json:"
        cat package.json | jq '.name, .version, .dependencies'
        echo ""
        echo "ğŸ“ˆ EstatÃ­sticas do cÃ³digo:"
        echo "  - Arquivos JS: $(find . -name '*.js' | wc -l)"
        echo "  - Linhas de cÃ³digo: $(find . -name '*.js' -exec wc -l {} + | tail -1 | awk '{print $1}')"
        
    - name: ğŸ§¹ VerificaÃ§Ã£o de qualidade
      run: |
        cd ${{ env.WORKING_DIR }}
        echo "ğŸ” Verificando qualidade do cÃ³digo..."
        # Verificar sintaxe JavaScript
        for file in $(find . -name '*.js'); do
          echo "Verificando: $file"
          node -c "$file" && echo "âœ… $file - OK" || echo "âŒ $file - ERRO"
        done
        
    - name: âœ… Build concluÃ­do
      run: echo "ğŸ‰ Build do microserviÃ§o Estoque.io finalizado com sucesso!"

  # Job de testes abrangentes
  test:
    name: ğŸ§ª Testes Completos
    runs-on: ubuntu-latest
    needs: [validate, build]
    strategy:
      matrix:
        test-type: ['unit', 'integration', 'api']
    
    steps:
    - name: ğŸ“¥ Checkout do cÃ³digo
      uses: actions/checkout@v4
      
    - name: ğŸŸ¢ Configurar Node.js ${{ env.NODE_VERSION }}
      uses: actions/setup-node@v4
      with:
        node-version: ${{ env.NODE_VERSION }}
        cache: 'npm'
        cache-dependency-path: '${{ env.WORKING_DIR }}/package-lock.json'
        
    - name: ğŸ§ª InÃ­cio dos testes - ${{ matrix.test-type }}
      run: echo "ğŸ”¬ Iniciando testes ${{ matrix.test-type }} do microserviÃ§o Estoque.io..."
      
    - name: ğŸ“¦ Instalar dependÃªncias
      run: |
        cd ${{ env.WORKING_DIR }}
        npm ci --prefer-offline --no-audit
        
    - name: ğŸš€ Iniciar servidor para testes
      if: matrix.test-type != 'unit'
      run: |
        cd ${{ env.WORKING_DIR }}
        echo "ğŸŒ Iniciando servidor na porta ${{ env.SERVICE_PORT }}..."
        node server.js &
        SERVER_PID=$!
        echo "SERVER_PID=$SERVER_PID" >> $GITHUB_ENV
        
        # Aguardar servidor inicializar
        echo "â³ Aguardando servidor inicializar..."
        for i in {1..10}; do
          if curl -s http://localhost:${{ env.SERVICE_PORT }} > /dev/null; then
            echo "âœ… Servidor iniciado com sucesso!"
            break
          fi
          echo "Tentativa $i/10..."
          sleep 2
        done
        
    - name: ğŸ” Testes UnitÃ¡rios
      if: matrix.test-type == 'unit'
      run: |
        cd ${{ env.WORKING_DIR }}
        echo "ğŸ§ª Executando testes unitÃ¡rios..."
        
        # Teste de carregamento de dados
        echo "ğŸ“Š Testando carregamento de dados..."
        node -e "
          try {
            const products = require('./data/products.js');
            console.log('âœ… Dados carregados:', products.length, 'produtos');
            products.forEach(p => console.log('  -', p.name, '(ID:', p.id, ', Qty:', p.quantity, ')'));
            process.exit(0);
          } catch(e) {
            console.error('âŒ Erro ao carregar dados:', e.message);
            process.exit(1);
          }
        "
        
        # Teste de sintaxe do servidor
        echo "ğŸ” Testando sintaxe do servidor..."
        node -c server.js && echo "âœ… Sintaxe do servidor OK" || (echo "âŒ Erro de sintaxe" && exit 1)
        
    - name: ğŸ” Testes de IntegraÃ§Ã£o
      if: matrix.test-type == 'integration'
      run: |
        echo "ğŸ”— Executando testes de integraÃ§Ã£o..."
        
        # Teste de conectividade
        echo "ğŸ“¡ Testando conectividade do servidor..."
        response=$(curl -s -o /dev/null -w "%{http_code}" http://localhost:${{ env.SERVICE_PORT }} || echo "000")
        if [ "$response" = "200" ] || [ "$response" = "404" ]; then
          echo "âœ… SUCESSO: Servidor respondendo (HTTP $response)"
        else
          echo "âŒ FALHA: Servidor nÃ£o responde (HTTP $response)"
          exit 1
        fi
        
        # Teste de arquivos estÃ¡ticos
        echo "ğŸ“ Testando servir arquivos estÃ¡ticos..."
        static_response=$(curl -s -o /dev/null -w "%{http_code}" http://localhost:${{ env.SERVICE_PORT }}/index.html || echo "000")
        if [ "$static_response" = "200" ]; then
          echo "âœ… SUCESSO: Arquivos estÃ¡ticos sendo servidos"
        else
          echo "âš ï¸ AVISO: Arquivos estÃ¡ticos nÃ£o encontrados (HTTP $static_response)"
        fi
        
    - name: ğŸ” Testes de API
      if: matrix.test-type == 'api'
      run: |
        echo "ğŸŒ Executando testes de API..."
        
        # Teste 1: Produto existente
        echo "ğŸ“‹ Teste 1: Consultando produto existente (ID: 101)..."
        response=$(curl -s "http://localhost:${{ env.SERVICE_PORT }}/inventory/check?productId=101")
        if echo "$response" | jq -e '.name' > /dev/null 2>&1; then
          echo "âœ… SUCESSO: API retornou dados vÃ¡lidos"
          echo "ğŸ“„ Resposta: $response" | jq .
        else
          echo "âŒ FALHA: API nÃ£o retornou dados esperados"
          echo "ğŸ“„ Resposta: $response"
          exit 1
        fi
        
        # Teste 2: Produto inexistente
        echo "ğŸ“‹ Teste 2: Consultando produto inexistente (ID: 999)..."
        error_response=$(curl -s "http://localhost:${{ env.SERVICE_PORT }}/inventory/check?productId=999")
        if echo "$error_response" | jq -e '.error' > /dev/null 2>&1; then
          echo "âœ… SUCESSO: API retornou erro apropriado"
          echo "ğŸ“„ Resposta: $error_response" | jq .
        else
          echo "âŒ FALHA: API nÃ£o tratou produto inexistente corretamente"
          exit 1
        fi
        
        # Teste 3: Produto sem estoque
        echo "ğŸ“‹ Teste 3: Consultando produto sem estoque (ID: 102)..."
        stock_response=$(curl -s "http://localhost:${{ env.SERVICE_PORT }}/inventory/check?productId=102")
        if echo "$stock_response" | jq -e '.inStock == false' > /dev/null 2>&1; then
          echo "âœ… SUCESSO: API identificou produto sem estoque corretamente"
          echo "ğŸ“„ Resposta: $stock_response" | jq .
        else
          echo "âŒ FALHA: API nÃ£o identificou falta de estoque"
          exit 1
        fi
        
        # Teste 4: Performance
        echo "ğŸ“‹ Teste 4: Testando performance da API..."
        start_time=$(date +%s%N)
        for i in {1..5}; do
          curl -s "http://localhost:${{ env.SERVICE_PORT }}/inventory/check?productId=101" > /dev/null
        done
        end_time=$(date +%s%N)
        duration=$(( (end_time - start_time) / 1000000 ))
        echo "â±ï¸ 5 requisiÃ§Ãµes executadas em ${duration}ms (mÃ©dia: $((duration/5))ms por requisiÃ§Ã£o)"
        
    - name: ğŸ§¹ Limpeza
      if: always() && matrix.test-type != 'unit'
      run: |
        if [ ! -z "$SERVER_PID" ]; then
          echo "ğŸ›‘ Finalizando servidor (PID: $SERVER_PID)..."
          kill $SERVER_PID 2>/dev/null || true
        fi
        
    - name: ğŸ‰ Testes ${{ matrix.test-type }} concluÃ­dos
      run: echo "ğŸ† Testes ${{ matrix.test-type }} do microserviÃ§o Estoque.io executados com sucesso!"

  # Job de relatÃ³rio final
  report:
    name: ğŸ“Š RelatÃ³rio Final
    runs-on: ubuntu-latest
    needs: [validate, build, test]
    if: always()
    
    steps:
    - name: ğŸ“Š Gerar relatÃ³rio do pipeline
      run: |
        echo "ğŸ“‹ ===== RELATÃ“RIO FINAL DO PIPELINE ====="
        echo "ğŸ• Data/Hora: $(date)"
        echo "ğŸ”§ Commit: ${{ github.sha }}"
        echo "ğŸ‘¤ Autor: ${{ github.actor }}"
        echo "ğŸŒ¿ Branch: ${{ github.ref_name }}"
        echo ""
        echo "ğŸ“ˆ Status dos Jobs:"
        echo "  - ValidaÃ§Ã£o: ${{ needs.validate.result }}"
        echo "  - Build: ${{ needs.build.result }}"
        echo "  - Testes: ${{ needs.test.result }}"
        echo ""
        if [ "${{ needs.validate.result }}" = "success" ] && [ "${{ needs.build.result }}" = "success" ] && [ "${{ needs.test.result }}" = "success" ]; then
          echo "ğŸ‰ PIPELINE EXECUTADO COM SUCESSO! ğŸš€"
          echo "âœ… MicroserviÃ§o Estoque.io estÃ¡ pronto para produÃ§Ã£o!"
        else
          echo "âš ï¸ Pipeline concluÃ­do com problemas - revisar logs acima"
        fi
        echo "============================================"