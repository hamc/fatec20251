name: Testes Microserviço Produtos

on:
  push:
    branches: [ main ]
  pull_request:
    branches: [ main ]

jobs:
  test:
    runs-on: ubuntu-latest

    steps:
    - name: 🔄 Clonar repositório
      uses: actions/checkout@v4

    - name: 🔧 Instalar dependências
      run: npm install

    - name: ▶️ Iniciar servidor em background
      run: |
        node app.js &
        sleep 3

    - name: 🧪 Testar rota /products/check com produto existente (id=101)
      run: |
        RESPONSE=$(curl -s http://localhost:3000/products/check?productId=101)
        echo "Resposta da API: $RESPONSE"
        echo "$RESPONSE" | grep '"available":true' || (echo "❌ Falha no teste: produto deveria estar disponível" && exit 1)

    - name: 🧪 Testar rota /products/check com produto inexistente (id=999)
      run: |
        STATUS=$(curl -s -o /dev/null -w "%{http_code}" http://localhost:3000/products/check?productId=999)
        echo "Status da API: $STATUS"
        [ "$STATUS" -eq 404 ] || (echo "❌ Falha no teste: deveria retornar 404" && exit 1)

    - name: ✅ Todos os testes passaram
      run: echo "✔️ Testes executados com sucesso!"
